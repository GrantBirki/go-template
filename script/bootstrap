#!/usr/bin/env bash

set -euo pipefail

source script/env "$@"

echo -e "${BLUE}ðŸ¥¾ Bootstrapping...${OFF}"

# Install goreleaser only if not already installed and in CI environment
if [[ "${CI:-}" == "true" ]]; then
  if ! command -v goreleaser &> /dev/null; then
    GORELEASER_VERSION=$(cat .goreleaser-version)
    echo "GORELEASER_VERSION=${GORELEASER_VERSION}" >> $GITHUB_OUTPUT
    echo "Using goreleaser version ${GORELEASER_VERSION}"      
    sudo dpkg -i vendor_bin/goreleaser_${GORELEASER_VERSION}_amd64.deb
  fi

  # do the same for golangci-lint
  if ! command -v golangci-lint &> /dev/null; then
    GOLANGCI_LINT_VERSION=$(cat .golangci-lint-version)
    echo "GOLANGCI_LINT_VERSION=${GOLANGCI_LINT_VERSION}" >> $GITHUB_OUTPUT
    echo "Using golangci-lint version ${GOLANGCI_LINT_VERSION}"
    sudo dpkg -i vendor_bin/golangci-lint-${GOLANGCI_LINT_VERSION}-linux-amd64.deb
  fi
fi

# Hermetic check: ensure all imports resolve from vendor/ only
# This avoids touching the network or the module cache.
go list -mod=vendor -deps ./... > /dev/null

echo -e "${GREEN}âœ… Bootstrap complete!${OFF}"
